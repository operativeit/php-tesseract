name: CI

on:
  pull_request:
  push:
    branches: ["master", "dev"]

jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ["8.4", "8.5"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: phpize
          coverage: none

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool make gcc g++ pkg-config \
            libtesseract-dev libleptonica-dev tesseract-ocr-eng

      - name: Set TESSDATA_PREFIX (point to tessdata/)
        run: |
          set -euo pipefail
          # Prefer: locate eng.traineddata installed by the package
          ENG_FILE="$(dpkg -L tesseract-ocr-eng 2>/dev/null | grep -E '/tessdata/eng\.traineddata$' | head -n 1 || true)"
          if [ -n "$ENG_FILE" ]; then
            TESSDATA_DIR="$(dirname "$ENG_FILE")"
          else
            # Fallbacks
            for d in \
              /usr/share/tesseract-ocr/5/tessdata \
              /usr/share/tesseract-ocr/4.00/tessdata \
              /usr/share/tessdata; do
              if [ -f "$d/eng.traineddata" ]; then
                TESSDATA_DIR="$d"
                break
              fi
            done
          fi

          if [ -z "${TESSDATA_DIR:-}" ] || [ ! -f "$TESSDATA_DIR/eng.traineddata" ]; then
            echo "Could not find eng.traineddata. Searching..."
            FOUND="$(sudo find /usr/share -path '*tessdata/eng.traineddata' -print -quit 2>/dev/null || true)"
            if [ -n "$FOUND" ]; then
              TESSDATA_DIR="$(dirname "$FOUND")"
            fi
          fi

          if [ -z "${TESSDATA_DIR:-}" ] || [ ! -f "$TESSDATA_DIR/eng.traineddata" ]; then
            echo "ERROR: eng.traineddata not found"
            exit 1
          fi

          echo "TESSDATA_PREFIX=$TESSDATA_DIR" >> $GITHUB_ENV
          echo "Using TESSDATA_PREFIX=$TESSDATA_DIR"
          ls -lah "$TESSDATA_DIR" | head -n 50

      - name: Detect extension dir
        id: extdir
        run: |
          if ls -d tesseract-* >/dev/null 2>&1; then
            DIR="$(ls -d tesseract-* | sort -V | tail -n 1)"
          else
            DIR="."
          fi
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "Using dir=$DIR"

      - name: Build extension
        run: |
          cd "${{ steps.extdir.outputs.dir }}"
          phpize
          ./configure
          make -j"$(nproc)"

      - name: Sanity check (CLI)
        run: |
          cd "${{ steps.extdir.outputs.dir }}"
          php -d opcache.enable=0 -d opcache.enable_cli=0 -d opcache.jit=0 -d opcache.protect_memory=0 \
             -d extension=modules/tesseract.so -r '
               $t=new Operativeit\Tesseract("eng");
               $t->setImage(__DIR__."/tests/quick-brown-fox.png");
               $s=$t->getUTF8Text();
               echo "LEN=".strlen($s)."\n";
               echo substr($s,0,120)."\n";
             '

      - name: Run PHPT tests (opcache/jit off)
        run: |
          cd "${{ steps.extdir.outputs.dir }}"
          if ls tests/*.phpt >/dev/null 2>&1; then
            make test TESTS="tests" REPORT_EXIT_STATUS=1 NO_INTERACTION=1 \
              TEST_PHP_ARGS="-d opcache.enable=0 -d opcache.enable_cli=0 -d opcache.jit=0 -d opcache.protect_memory=0 -vv"
          else
            echo "No PHPT tests found"
          fi

      - name: Install gdb (8.5 only)
        if: failure() && matrix.php == '8.5'
        run: sudo apt-get update && sudo apt-get install -y gdb

      - name: GDB backtrace (8.5 only)
        if: failure() && matrix.php == '8.5'
        run: |
          cd "${{ steps.extdir.outputs.dir }}"
          cat > /tmp/repro.php <<'PHP'
          <?php
          $t = new Operativeit\Tesseract("eng");
          $t->setImage(__DIR__ . "/tests/quick-brown-fox.png");
          $s = $t->getUTF8Text();
          $s = trim(preg_replace('/\s+/u', ' ', strtolower($s)));
          echo preg_match('/the quick brown fox.*jumped over the lazy dog\.?/i', $s) ? "OK\n" : "FAIL\n";
          PHP

          gdb --batch \
            -ex "set pagination off" \
            -ex "run" \
            -ex "bt full" \
            --args php \
              -d opcache.enable=0 -d opcache.enable_cli=0 -d opcache.jit=0 -d opcache.protect_memory=0 \
              -d extension=modules/tesseract.so /tmp/repro.php

      - name: Upload PHPT artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: phpt-${{ matrix.php }}
          path: |
            ${{ steps.extdir.outputs.dir }}/tests/*.diff
            ${{ steps.extdir.outputs.dir }}/tests/*.out
            ${{ steps.extdir.outputs.dir }}/tests/*.exp
            ${{ steps.extdir.outputs.dir }}/tests/*.log
            ${{ steps.extdir.outputs.dir }}/tmp-php.ini
            ${{ steps.extdir.outputs.dir }}/run-tests.php
